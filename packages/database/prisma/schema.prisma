// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Core Tenant Models
// ============================================

model Tenant {
  id            String   @id @default(cuid())
  name          String
  slug          String   @unique
  description   String?
  status        String   @default("active") // active, suspended, deleted
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  users         User[]
  authDomain    AuthDomain?
  publishDomain PublishDomain?
  pages         Page[]
  templates     PageTemplate[]
  components    CustomComponent[]
  analytics     AnalyticsEvent[]
  domains       CustomDomain[]
  content       Content[]
  customComponents TenantCustomComponent[] @relation("tenantCustomComponents")
  jsFunctions   JavaScriptFunction[] @relation("tenantJsFunctions")
  componentStyles TenantComponentStyle[] @relation("tenantComponentStyles")
  versionNotifications VersionNotification[] @relation("versionNotifications")

  @@index([status])
  @@index([createdAt])
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String
  firstName     String
  lastName      String
  role          String   @default("editor") // admin, tenant-admin, editor
  status        String   @default("active")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  tenantId      String?
  tenant        Tenant?  @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  previewAccess PreviewAccess[]

  @@index([tenantId])
  @@index([role])
}

// ============================================
// Domain Models
// ============================================

model AuthDomain {
  id        String   @id @default(cuid())
  subdomain String   @unique // e.g., "myautodealership-auth"
  domain    String   @default("autodealercloud.com")
  status    String   @default("active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenantId  String   @unique
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model PublishDomain {
  id        String   @id @default(cuid())
  subdomain String   @unique // e.g., "myautodealership-pub"
  domain    String   @default("autodealercloud.com")
  status    String   @default("active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenantId  String   @unique
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model CustomDomain {
  id           String   @id @default(cuid())
  domain       String   @unique // e.g., "www.myautodealership.com" or "myautodealership.com"
  type         String   @default("www") // www, root
  ssl          Boolean  @default(false)
  deployed     Boolean  @default(false) // Whether Nginx config has been deployed
  dnsVerified  Boolean  @default(false) // Whether DNS points to this server
  dnsRecord    String?  // DNS TXT record for verification
  status       String   @default("pending") // pending, configured, dns-verified, failed
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([deployed])
  @@index([dnsVerified])
}

// Old component models retained for backward compatibility
// New component system uses ComponentDefinition instead

model Component {
  id          String   @id @default(cuid())
  type        String   // atom, molecule, organism
  name        String   // e.g., "button", "card", "header"
  slug        String   @unique
  description String?
  category    String?  // visual, form, content, layout, navigation, etc.
  metadata    Json     @default("{}") // props schema, default values, etc.
  status      String   @default("active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  versions    ComponentVersion[]
  usedInComponents ComponentComposition[] @relation("parentComponent")
  usesComponents ComponentComposition[] @relation("childComponent")

  @@index([type])
  @@index([category])
  @@unique([slug, type])
}

model ComponentVersion {
  id          String   @id @default(cuid())
  version     String   // semver: 1.0.0
  htmlContent String?  // HTML template
  cssContent  String?  // CSS/Tailwind styles
  jsContent   String?  // JavaScript logic
  status      String   @default("draft") // draft, published
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  componentId String
  component   Component @relation(fields: [componentId], references: [id], onDelete: Cascade)

  @@unique([componentId, version])
  @@index([componentId])
  @@index([status])
}

model ComponentComposition {
  id        String   @id @default(cuid())
  order     Int      // Order in parent component
  createdAt DateTime @default(now())

  parentComponentId String
  parentComponent   Component @relation("parentComponent", fields: [parentComponentId], references: [id], onDelete: Cascade)

  childComponentId String
  childComponent   Component @relation("childComponent", fields: [childComponentId], references: [id], onDelete: Cascade)

  @@unique([parentComponentId, childComponentId])
  @@index([parentComponentId])
}

model CustomComponent {
  id          String   @id @default(cuid())
  name        String
  slug        String
  description String?
  metadata    Json     @default("{}") // composition of core components
  status      String   @default("active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, slug])
  @@index([tenantId])
}

// ============================================
// Component Definition Models (Core Components)
// ============================================

model ComponentDefinition {
  id          String   @id @default(cuid())
  type        String   // atom, molecule, organism
  name        String   // e.g., "Button", "Card", "Header"
  slug        String   @unique
  description String?
  category    String?  // visual, form, content, layout, navigation, etc.
  propSchema  Json     @default("{}") // Schema for component props
  defaultCss  String?  // Default CSS classes
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  versions    ComponentDefinitionVersion[]
  usedInComponents ComponentCompositionDefinition[] @relation("parentDefinition")
  usesComponents   ComponentCompositionDefinition[] @relation("childDefinition")
  styles      ComponentStyle[]
  templates   JavaScriptFunctionTemplate[]
  versionHistory ComponentVersionHistory[]

  @@index([type])
  @@index([category])
}

model ComponentDefinitionVersion {
  id          String   @id @default(cuid())
  version     String   // semver: 1.0.0
  htmlContent String?  // HTML template
  cssContent  String?  // CSS content
  jsHooks     Json     @default("[]") // Available JS hook points
  releaseNotes String?
  status      String   @default("published") // published, draft
  createdAt   DateTime @default(now())

  componentId String
  component   ComponentDefinition @relation(fields: [componentId], references: [id], onDelete: Cascade)

  @@unique([componentId, version])
  @@index([componentId])
}

model ComponentCompositionDefinition {
  id        String   @id @default(cuid())
  order     Int      // Order in parent component
  createdAt DateTime @default(now())

  parentComponentId String
  parentComponent   ComponentDefinition @relation("parentDefinition", fields: [parentComponentId], references: [id], onDelete: Cascade)

  childComponentId String
  childComponent   ComponentDefinition @relation("childDefinition", fields: [childComponentId], references: [id], onDelete: Cascade)

  @@unique([parentComponentId, childComponentId])
  @@index([parentComponentId])
}

// ============================================
// Component Style Model
// ============================================

model ComponentStyle {
  id          String   @id @default(cuid())
  name        String   // e.g., "Primary Button", "Large Card"
  cssContent  String?  // Raw CSS
  visualStyle Json     @default("{}") // Visual editor settings (colors, spacing, etc.)
  appliedClasses String? // CSS classes to apply
  mode        String   @default("visual") // visual, text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  componentId String
  component   ComponentDefinition @relation(fields: [componentId], references: [id], onDelete: Cascade)

  @@index([componentId])
}

model TenantComponentStyle {
  id          String   @id @default(cuid())
  name        String
  cssContent  String?
  visualStyle Json     @default("{}")
  appliedClasses String?
  mode        String   @default("visual")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenantId    String
  tenant      Tenant   @relation("tenantComponentStyles", fields: [tenantId], references: [id], onDelete: Cascade)

  customComponentId String?
  customComponent   TenantCustomComponent? @relation(fields: [customComponentId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([customComponentId])
}

// ============================================
// JavaScript Function Templates
// ============================================

model JavaScriptFunctionTemplate {
  id          String   @id @default(cuid())
  name        String   // e.g., "Scroll to Section", "Send Email"
  description String?
  functionBody String  // JS code with {{ placeholders }}
  placeholders Json     @default("[]") // [{ name: "sectionId", type: "string", required: true }]
  eventTypes  String   // comma-separated: click, load, scroll, hover, change, submit
  selector    String?  // CSS selector hint
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  componentId String?
  component   ComponentDefinition? @relation(fields: [componentId], references: [id], onDelete: SetNull)

  instances   JavaScriptFunction[]

  @@index([componentId])
}

model JavaScriptFunction {
  id          String   @id @default(cuid())
  name        String
  eventType   String   // click, load, scroll, hover, change, submit
  selector    String?  // CSS selector for the element
  params      Json     @default("{}") // {{ placeholder }} values filled in by tenant
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  templateId  String?
  template    JavaScriptFunctionTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  pageId      String?
  page        PageVersion? @relation(fields: [pageId], references: [id], onDelete: Cascade)

  tenantId    String
  tenant      Tenant   @relation("tenantJsFunctions", fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([pageId])
  @@index([tenantId])
}

// ============================================
// Page & Template Models (Enhanced)
// ============================================

model Page {
  id          String   @id @default(cuid())
  slug        String
  title       String   @default("")
  description String?
  metadata    Json     @default("{}") // SEO, og tags, etc.
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  versions    PageVersion[]
  templates   Template[]
  pageTemplate PageTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  templateId  String?

  @@unique([tenantId, slug])
  @@index([tenantId])
}

model PageVersion {
  id          String   @id @default(cuid())
  versionNumber Int
  versionName String   @default("") // e.g., "Landing Page v1.2"
  content     Json     @default("{}") // Component tree structure
  status      String   @default("draft") // draft, preview, published
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  publishedAt DateTime?

  pageId      String
  page        Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)

  jsFunctions JavaScriptFunction[]
  previewAccess PreviewAccess[]

  @@unique([pageId, versionNumber])
  @@index([pageId])
  @@index([status])
}

model PageTemplate {
  id          String   @id @default(cuid())
  name        String
  slug        String
  description String?
  content     Json     @default("{}") // Template structure (without tenant content)
  status      String   @default("active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  pages       Page[]

  @@unique([tenantId, slug])
  @@index([tenantId])
}

// ============================================
// Template with Zones Model
// ============================================

model Template {
  id          String   @id @default(cuid())
  name        String
  slug        String
  description String?
  zones       Zone[]   // Template areas with restrictions
  previewHtml String?  // HTML for template preview
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  pageId      String
  page        Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@index([pageId])
}

model Zone {
  id          String   @id @default(cuid())
  name        String   // e.g., "Hero", "Content", "Footer"
  componentRestrictions Json @default("[]") // Array of allowed component slugs (empty = allow all)
  content     Json     @default("{}") // Zone content
  order       Int      // Order in template

  templateId  String
  template    Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
}

// ============================================
// Preview Access Model
// ============================================

model PreviewAccess {
  id          String   @id @default(cuid())
  permission  String   @default("view") // view, edit
  createdAt   DateTime @default(now())
  expiresAt   DateTime?

  pageVersionId String
  pageVersion   PageVersion @relation(fields: [pageVersionId], references: [id], onDelete: Cascade)

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([pageVersionId, userId])
  @@index([pageVersionId])
  @@index([userId])
}

// ============================================
// Component Version History & Notifications
// ============================================

model ComponentVersionHistory {
  id          String   @id @default(cuid())
  oldVersion  String
  newVersion  String
  changes     Json     @default("{}") // What changed: { breaking: [], added: [], modified: [] }
  releaseNotes String?
  createdAt   DateTime @default(now())

  componentId String
  component   ComponentDefinition @relation(fields: [componentId], references: [id], onDelete: Cascade)

  notifications VersionNotification[]

  @@index([componentId])
}

model VersionNotification {
  id          String   @id @default(cuid())
  message     String
  acknowledged Boolean @default(false)
  actionTaken String?  // "updated", "ignored", "rolled_back"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  historyId   String
  history     ComponentVersionHistory @relation(fields: [historyId], references: [id], onDelete: Cascade)

  tenantId    String
  tenant      Tenant   @relation("versionNotifications", fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([historyId])
  @@index([tenantId])
  @@index([acknowledged])
}

// ============================================
// Tenant Custom Component Model
// ============================================

model TenantCustomComponent {
  id          String   @id @default(cuid())
  name        String
  slug        String
  description String?
  composition Json     @default("{}") // Structure: how it composes core/other components
  metadata    Json     @default("{}")
  versions    TenantComponentVersion[]
  styles      TenantComponentStyle[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenantId    String
  tenant      Tenant   @relation("tenantCustomComponents", fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, slug])
  @@index([tenantId])
}

model TenantComponentVersion {
  id          String   @id @default(cuid())
  version     String   // semver
  composition Json     @default("{}")
  createdAt   DateTime @default(now())

  componentId String
  component   TenantCustomComponent @relation(fields: [componentId], references: [id], onDelete: Cascade)

  @@unique([componentId, version])
}

// ============================================
// Content Model
// ============================================

model Content {
  id        String   @id @default(cuid())
  pageId    String
  componentPath String // e.g., "sections.0.components.1"
  componentType String // e.g., "button", "card", etc.
  data      Json     @default("{}") // Component-specific content
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([pageId, componentPath])
  @@index([tenantId])
  @@index([pageId])
}

// ============================================
// Analytics Models
// ============================================

model AnalyticsEvent {
  id        String   @id @default(cuid())
  eventType String   // pageview, click, form_submit, etc.
  data      Json     @default("{}") // Event-specific data
  createdAt DateTime @default(now())

  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([eventType])
  @@index([createdAt])
}

model TenantAnalytics {
  id          String   @id @default(cuid())
  date        DateTime
  pageViews   Int      @default(0)
  uniqueUsers Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenantId    String
}
